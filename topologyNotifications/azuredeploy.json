{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json",
    "contentVersion": "1.0.0.0",
    "parameters": {
	"adminUsername": {
	    "type": "string"
	},
	"adminPassword": {
	    "type": "securestring"
	},
	"tenantId": {
	    "type": "securestring"
	},
	"applicationId": {
	    "type": "securestring"
	},
	"applicationSecret": {
	    "type": "securestring"
	},
	"scaleSetRegion": {
	    "type": "string",
	    "defaultValue": "westus"
	},
	"vmRegion": {
	    "type": "string",
	    "defaultValue": "eastus"
	},
	"_artifactsLocation": {
	    "type": "string",
	    "defaultValue": "https://raw.githubusercontent.com/gatneil/templates/topologyNotifications/topologyNotifications"
	}
    },
    "variables": {},
    "resources": [
	{
	    "type": "Microsoft.Network/virtualNetworks",
	    "name": "myVnet",
	    "location": "[parameters('scaleSetRegion')]",
	    "apiVersion": "2016-12-01",
	    "properties": {
		"addressSpace": {
		    "addressPrefixes": [
			"10.0.0.0/16"
		    ]
		},
		"subnets": [
		    {
			"name": "mySubnet",
			"properties": {
			    "addressPrefix": "10.0.0.0/16"
			}
		    }
		]
	    }
	},
	{
	    "type": "Microsoft.Network/virtualNetworks",
	    "name": "myVnet2",
	    "location": "[parameters('vmRegion')]",
	    "apiVersion": "2016-12-01",
	    "properties": {
		"addressSpace": {
		    "addressPrefixes": [
			"10.0.0.0/16"
		    ]
		},
		"subnets": [
		    {
			"name": "mySubnet",
			"properties": {
			    "addressPrefix": "10.0.0.0/16"
			}
		    }
		]
	    }
	},
	{
	    "apiVersion": "2017-04-01",
	    "type": "Microsoft.Network/publicIPAddresses",
	    "name": "myPip",
	    "location": "[parameters('vmRegion')]",
	    "properties": {
		"publicIPAllocationMethod": "Dynamic"
	    }
	},
	{
	    "apiVersion": "2017-04-01",
	    "type": "Microsoft.Network/networkInterfaces",
	    "name": "myNic",
	    "location": "[parameters('vmRegion')]",
	    "dependsOn": [
		"Microsoft.Network/publicIPAddresses/myPip",
		"Microsoft.Network/virtualNetworks/myVnet2"
	    ],
	    "properties": {
		"ipConfigurations": [
		    {
			"name": "ipconfig1",
			"properties": {
			    "privateIPAllocationMethod": "Dynamic",
			    "publicIPAddress": {
				"id": "[resourceId('Microsoft.Network/publicIPAddresses', 'myPip')]"
			    },
			    "subnet": {
				"id": "[concat(resourceId('Microsoft.Network/virtualNetworks', 'myVnet2'), '/subnets/mySubnet')]"
			    }
			}
		    }
		]
	    }
	},
	{
	    "type": "Microsoft.Compute/virtualMachines",
	    "name": "myVM",
	    "location": "[parameters('vmRegion')]",
	    "apiVersion": "2016-04-30-preview",
	    "dependsOn": [
		"Microsoft.Network/networkInterfaces/myNic"
	    ],
	    "properties": {
		"hardwareProfile": {
		    "vmSize": "Standard_A1"
		},
		"storageProfile": {
		    "imageReference": {
			"publisher": "Canonical",
			"offer": "UbuntuServer",
			"sku": "16.04-LTS",
			"version": "latest"
		    }
		},
		"osProfile": {
		    "computerName": "vm",
		    "adminUsername": "[parameters('adminUsername')]",
		    "adminPassword": "[parameters('adminPassword')]"
		},
		"networkProfile": {
		    "networkInterfaces": [
			{
			    "id": "[resourceId('Microsoft.Network/networkInterfaces', 'myNic')]"
			}
		    ]
		}
	    }
	},
	{
	    "type": "Microsoft.Compute/virtualMachines/extensions",
	    "name": "myVM/ext",
	    "apiVersion": "2017-03-30",
	    "location": "[parameters('vmRegion')]",
	    "dependsOn": [
		"Microsoft.Compute/virtualMachines/myVM",
		"Microsoft.Compute/virtualMachineScaleSets/myScaleSet"
	    ],
	    "properties": {
		"publisher": "Microsoft.Azure.Extensions",
		"type": "CustomScript",
		"typeHandlerVersion": "2.0",
		"autoUpgradeMinorVersion": true,
		"settings": {
		    "fileUris": [
			"[concat(parameters('_artifactsLocation'), '/get_topology_notifications.sh')]"
		    ],
		    "commandToExecute": "[concat('bash get_topology_notifications.sh ', parameters('tenantId'), ' ', parameters('applicationId'), ' ', parameters('applicationSecret'), ' ', resourceId('Microsoft.Compute/virtualMachineScaleSets', 'myScaleSet'))]"
		}
	    }
	},
	{
	    "type": "Microsoft.Compute/virtualMachineScaleSets",
	    "name": "myScaleSet",
	    "location": "[parameters('scaleSetRegion')]",
	    "apiVersion": "2016-04-30-preview",
	    "dependsOn": [
		"Microsoft.Network/virtualNetworks/myVnet"
	    ],
	    "sku": {
		"name": "Standard_A1",
		"capacity": 2
	    },
	    "properties": {
		"upgradePolicy": {
		    "mode": "Manual"
		},
		"virtualMachineProfile": {
		    "storageProfile": {
			"imageReference": {
			    "publisher": "Canonical",
			    "offer": "UbuntuServer",
			    "sku": "16.04-LTS",
			    "version": "latest"
			}
		    },
		    "osProfile": {
			"computerNamePrefix": "vm",
			"adminUsername": "[parameters('adminUsername')]",
			"adminPassword": "[parameters('adminPassword')]"
		    },
		    "networkProfile": {
			"networkInterfaceConfigurations": [
			    {
				"name": "myNic",
				"properties": {
				    "primary": "true",
				    "ipConfigurations": [
					{
					    "name": "myIpConfig",
					    "properties": {
						"subnet": {
						    "id": "[concat(resourceId('Microsoft.Network/virtualNetworks', 'myVnet'), '/subnets/mySubnet')]"
						}
					    }
					}
				    ]
				}
			    }
			]
		    }
		}
	    }
	},
	{
	    "type": "Microsoft.Insights/autoscaleSettings",
	    "apiVersion": "2015-04-01",
	    "name": "autoscalehost",
	    "location": "[parameters('scaleSetRegion')]",
	    "dependsOn": [
		"Microsoft.Compute/virtualMachineScaleSets/myScaleSet"
	    ],
	    "properties": {
		"name": "autoscalehost",
		"targetResourceUri": "[resourceId('Microsoft.Compute/virtualMachineScaleSets', 'myScaleSet')]",
		"enabled": true,
		"profiles": [
		    {
			"name": "Profile1",
			"capacity": {
			    "minimum": "1",
			    "maximum": "10",
			    "default": "1"
			},
			"rules": [
			    {
				"metricTrigger": {
				    "metricName": "Percentage CPU",
				    "metricResourceUri": "[resourceId('Microsoft.Compute/virtualMachineScaleSets', 'myScaleSet')]",
				    "timeGrain": "PT1M",
				    "statistic": "Average",
				    "timeWindow": "PT5M",
				    "timeAggregation": "Average",
				    "operator": "GreaterThan",
				    "threshold": 60
				},
				"scaleAction": {
				    "direction": "Increase",
				    "type": "ChangeCount",
				    "value": "1",
				    "cooldown": "PT1M"
				}
			    },
			    {
				"metricTrigger": {
				    "metricName": "Percentage CPU",
				    "metricResourceUri": "[resourceId('Microsoft.Compute/virtualMachineScaleSets', 'myScaleSet')]",
				    "timeGrain": "PT1M",
				    "statistic": "Average",
				    "timeWindow": "PT5M",
				    "timeAggregation": "Average",
				    "operator": "LessThan",
				    "threshold": 30
				},
				"scaleAction": {
				    "direction": "Decrease",
				    "type": "ChangeCount",
				    "value": "1",
				    "cooldown": "PT1M"
				}
			    }
			]
		    }
		]
	    }
	}
    ]
}
